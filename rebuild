#! /bin/sh
# NOTE: calling sudo inside a script is not best practice, but it works in this case

# Get current hostname
HOSTNAME=$(hostname)
SYSTEM_ARG=${1:-$HOSTNAME}

# Map hostnames to directory names
get_system_dir() {
  case "$1" in
    "nixt460") echo "t460" ;;
    "nixhq") echo "hq" ;;
    "nixt15g") echo "t15g" ;;
    *) echo "$1" ;;  # Default to the name itself
  esac
}

SYSTEM_DIR=$(get_system_dir "$SYSTEM_ARG")

echo "Rebuilding system $SYSTEM_ARG..."
flatpak update -y
sudo nix-channel --update
sudo nix-env --delete-generations 60d
sudo nix-collect-garbage --delete-older-than 60d
sudo nixos-rebuild switch
retval=$?

if [ $retval -eq 0 ]; then
  echo "Build successful! Committing changes..."
  pushd /home/miscguy/coding/nixos
  git pull
  
  # Get current generation number
  gennbr="$(sudo nix-env --list-generations -p /nix/var/nix/profiles/system | grep current | awk '{print $1}')"
  
  # Get optional commit description
  if [ -n "$2" ]; then
    desc="$2"
    msg="$SYSTEM_ARG: generation $gennbr - $desc"
  else
    msg="$SYSTEM_ARG: generation $gennbr"
  fi
  
  # Selectively commit relevant files for this system
  git add flake.* ${SYSTEM_DIR}/* shared/* common/*
  git commit -m "$msg" 
  git push
  popd
  
  echo "Rebuild completed successfully!"
else
  echo "Build failed with error code $retval"
fi

# TODO: Future enhancements to consider:
# 1. Add a recovery mechanism that can roll back to previous generation if tests fail
#    - Create system-specific test scripts in each system directory
#    - After rebuild, run tests and roll back if they fail
#
# 2. Implement a lock file mechanism to prevent multiple concurrent rebuilds
#    - Create a lock file at the start of the script
#    - Check for existing lock file and exit if one exists
#    - Remove lock file on script completion or error
